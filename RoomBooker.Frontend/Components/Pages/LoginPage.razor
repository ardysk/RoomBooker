@page "/login"
@inject RoomBooker.Frontend.Services.ApiClient Api
@inject NavigationManager Nav
@inject RoomBooker.Frontend.Services.AuthState Auth

<h3>Logowanie</h3>

@if (Auth.IsAuthenticated)
{
    <p>Jesteœ ju¿ zalogowany jako <strong>@Auth.UserEmail</strong>.</p>
    <button class="btn btn-secondary" @onclick="@(()=>Nav.NavigateTo("/reservations"))">PrzejdŸ do rezerwacji</button>
}
else
{
    <EditForm Model="model" OnValidSubmit="HandleLogin">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label class="form-label">E-mail</label>
            <InputText class="form-control" @bind-Value="model.Email" />
        </div>

        <div class="mb-3">
            <label class="form-label">Has³o</label>
            <InputText type="password" class="form-control" @bind-Value="model.Password" />
        </div>

        <button class="btn btn-primary" type="submit" disabled="@isBusy">
            @(isBusy ? "Logowanie..." : "Zaloguj")
        </button>

        <div class="mt-3">
            <small>Nie masz konta? <a href="/register">Zarejestruj siê</a></small>
        </div>

        @if (!string.IsNullOrEmpty(error))
        {
            <div class="alert alert-danger mt-3">@error</div>
        }
        </EditForm>
}

@code {
    private LoginModel model = new();
    private bool isBusy;
    private string? error;

    private async Task HandleLogin()
    {
        isBusy = true;
        error = null;

        var success = await Auth.LoginAsync(model.Email, model.Password);

        if (!success)
        {
            error = "Logowanie nie powiod³o siê. SprawdŸ dane.";
        }
        else
        {
            Nav.NavigateTo("/reservations");
        }

        isBusy = false;
    }

    public class LoginModel
    {
        public string Email { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }
}